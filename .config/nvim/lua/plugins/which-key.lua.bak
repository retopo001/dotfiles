-- which-key.nvim: Full panel mode for rehearsal and overview
-- Configured for large, non-scroll panel showing all mappings at once
-- IMPORTANT: Disabled in vscode-neovim because it tries to sync layout with vscode API
-- which causes "vscode.internal" errors. Use Cursor's built-in command palette instead.

return {
  "folke/which-key.nvim",
  lazy = false,  -- Load immediately, not lazy

  -- Aggressively disable in vscode-neovim to avoid layout sync errors
  cond = function()
    return not (vim.g.vscode == 1)
  end,

  init = function()
    vim.o.timeout = true
    vim.o.timeoutlen = 300
  end,

  opts = {
    -- Window configuration (v3 format)
    win = {
      border = "rounded",
      padding = { 1, 2 },  -- { top/bottom, left/right }
      wo = {
        winblend = 0,
      },
    },

    -- Don't use custom triggers - let which-key auto-detect
    -- triggers = "auto" is the default in v3

    -- Only show mappings that actually have descriptions
    filter = function(mapping)
      return mapping.desc and mapping.desc ~= ""
    end,

    plugins = {
      marks = true,
      registers = true,
      spelling = {
        enabled = true,
        suggestions = 20,
      },
    },

    -- Key handling in popup
    keys = {
      scroll_down = "<C-d>",
      scroll_up = "<C-u>",
    },

    -- Show hints at bottom of popup
    show_help = true,
    show_keys = true,
  },

  config = function(_, opts)
    if vim.g.vscode == 1 then
      return
    end

    local wk = require("which-key")
    wk.setup(opts)

    -- ============================================
    -- GROUP LABELS
    -- ============================================
    wk.add({
      { "<leader>a", group = "AI" },
      { "<leader>b", group = "Buffer" },
      { "<leader>c", group = "Code" },
      { "<leader>d", group = "Diagnostics" },
      { "<leader>f", group = "Find" },
      { "<leader>g", group = "Git" },
      { "<leader>h", group = "Harpoon" },
      { "<leader>l", group = "LSP" },
      { "<leader>q", group = "Quit" },
      { "<leader>t", group = "Toggle" },
      { "<leader>w", group = "Window" },
      { "<leader>x", group = "Trouble" },
      { "<leader>y", group = "Yank" },
      -- Groups from other plugins that show "+N mappings"
      { "<leader>r", group = "Refactor" },
      { "<leader>s", group = "Search" },
      { "<leader>m", group = "Marks" },
      { "<leader>p", group = "Project" },
      { "<leader>T", group = "Treesitter" },
      { "gr", group = "LSP refs/rename" },
    })

    -- ============================================
    -- QUICK ACCESS - Single keys on leader
    -- ============================================
    wk.add({
      { "<leader>/", function() require("Comment.api").toggle.linewise.current() end, desc = "Comment line" },
      { "<leader>e", "<cmd>Oil<cr>", desc = "File explorer" },
      { "<leader>u", "<cmd>UndotreeToggle<cr>", desc = "Undo tree" },
      { "<leader>?", "<cmd>Telescope keymaps<cr>", desc = "ALL keymaps (search)" },
      -- Quick nav to other prefixes
      { "<leader>[", function() wk.show({ keys = "[", mode = "n" }) end, desc = "[ Prev motions" },
      { "<leader>]", function() wk.show({ keys = "]", mode = "n" }) end, desc = "] Next motions" },
    })

    -- ============================================
    -- ACTUAL MAPPINGS
    -- ============================================
    wk.add({
      -- AI
      { "<leader>ac", "<cmd>Claude<cr>", desc = "Claude" },

      -- Buffer
      { "<leader>bb", "<cmd>Telescope buffers<cr>", desc = "Buffer list" },
      { "<leader>bd", "<cmd>bdelete<cr>", desc = "Delete" },
      { "<leader>bn", "<cmd>bnext<cr>", desc = "Next" },
      { "<leader>bp", "<cmd>bprev<cr>", desc = "Prev" },

      -- Code
      { "<leader>ca", vim.lsp.buf.code_action, desc = "Action" },
      { "<leader>cf", function() require("conform").format() end, desc = "Format" },
      { "<leader>cr", vim.lsp.buf.rename, desc = "Rename" },

      -- Diagnostics
      { "<leader>dd", vim.diagnostic.open_float, desc = "Line diag" },
      { "<leader>dn", vim.diagnostic.goto_next, desc = "Next" },
      { "<leader>dp", vim.diagnostic.goto_prev, desc = "Prev" },
      { "<leader>dl", "<cmd>Telescope diagnostics<cr>", desc = "List" },

      -- Find
      { "<leader>ff", "<cmd>Telescope find_files<cr>", desc = "Files" },
      { "<leader>fg", "<cmd>Telescope live_grep<cr>", desc = "Grep" },
      { "<leader>fb", "<cmd>Telescope buffers<cr>", desc = "Buffers" },
      { "<leader>fh", "<cmd>Telescope help_tags<cr>", desc = "Help" },
      { "<leader>fo", "<cmd>Telescope oldfiles<cr>", desc = "Recent" },
      { "<leader>fk", "<cmd>Telescope keymaps<cr>", desc = "Keymaps" },
      { "<leader>ft", "<cmd>TodoTelescope<cr>", desc = "TODOs" },

      -- Git
      { "<leader>gb", "<cmd>Git blame<cr>", desc = "Blame" },
      { "<leader>gl", "<cmd>LazyGit<cr>", desc = "LazyGit" },
      { "<leader>gd", "<cmd>Gitsigns diffthis<cr>", desc = "Diff" },
      { "<leader>gw", "<cmd>edit /home/bw/dotfiles/docs/CURSOR-WORKFLOW-GUIDE.md<cr>", desc = "Workflow" },

      -- Harpoon
      { "<leader>ha", function() require("harpoon"):list():add() end, desc = "Add" },
      { "<leader>hh", function() require("harpoon").ui:toggle_quick_menu(require("harpoon"):list()) end, desc = "Menu" },
      { "<leader>h1", function() require("harpoon"):list():select(1) end, desc = "1" },
      { "<leader>h2", function() require("harpoon"):list():select(2) end, desc = "2" },
      { "<leader>h3", function() require("harpoon"):list():select(3) end, desc = "3" },
      { "<leader>h4", function() require("harpoon"):list():select(4) end, desc = "4" },

      -- LSP
      { "<leader>li", "<cmd>LspInfo<cr>", desc = "Info" },
      { "<leader>lr", "<cmd>LspRestart<cr>", desc = "Restart" },

      -- Quit
      { "<leader>qq", "<cmd>qa<cr>", desc = "All" },
      { "<leader>qw", "<cmd>wqa<cr>", desc = "Write+quit" },

      -- Toggle
      { "<leader>tn", "<cmd>set number!<cr>", desc = "Numbers" },
      { "<leader>tr", "<cmd>set relativenumber!<cr>", desc = "Relative" },
      { "<leader>tw", "<cmd>set wrap!<cr>", desc = "Wrap" },
      { "<leader>ts", "<cmd>set spell!<cr>", desc = "Spell" },
      { "<leader>th", function() require("close_buffers").delete({ type = "hidden" }) end, desc = "Close hidden" },

      -- Window
      { "<leader>wv", "<cmd>vsplit<cr>", desc = "Vsplit" },
      { "<leader>ws", "<cmd>split<cr>", desc = "Hsplit" },
      { "<leader>wc", "<cmd>close<cr>", desc = "Close" },
      { "<leader>wo", "<cmd>only<cr>", desc = "Only" },
      { "<leader>w=", "<C-w>=", desc = "Equal" },
      { "<leader>ww", "<cmd>w<cr>", desc = "Save" },

      -- Trouble
      { "<leader>xx", "<cmd>Trouble diagnostics toggle<cr>", desc = "Diagnostics" },
      { "<leader>xd", "<cmd>Trouble diagnostics toggle filter.buf=0<cr>", desc = "Buffer" },
      { "<leader>xl", "<cmd>Trouble loclist toggle<cr>", desc = "Loclist" },
      { "<leader>xq", "<cmd>Trouble qflist toggle<cr>", desc = "Quickfix" },
      { "<leader>xt", "<cmd>Trouble todo toggle<cr>", desc = "TODOs" },

      -- Yank
      { "<leader>yf", function()
          local path = vim.api.nvim_buf_get_name(0)
          vim.fn.setreg("+", path)
          vim.notify("Yanked: " .. path)
        end, desc = "Full path" },
      { "<leader>yr", function()
          local path = vim.fn.fnamemodify(vim.api.nvim_buf_get_name(0), ":~:.")
          vim.fn.setreg("+", path)
          vim.notify("Yanked: " .. path)
        end, desc = "Relative" },
    })

    -- ============================================
    -- NON-LEADER PREFIXES (for reference)
    -- ============================================
    wk.add({
      { "[", group = "Previous" },
      { "]", group = "Next" },
      { "g", group = "Go/LSP" },
      { "z", group = "Folds" },
      { "[d", desc = "Diagnostic" },
      { "[b", desc = "Buffer" },
      { "[q", desc = "Quickfix" },
      { "[t", desc = "Todo" },
      { "]d", desc = "Diagnostic" },
      { "]b", desc = "Buffer" },
      { "]q", desc = "Quickfix" },
      { "]t", desc = "Todo" },
      { "gd", desc = "Definition" },
      { "gr", desc = "References" },
      { "gi", desc = "Implementation" },
      { "gc", desc = "Comment" },
      { "gcc", desc = "Comment line" },
      { "zR", desc = "Open all" },
      { "zM", desc = "Close all" },
      { "za", desc = "Toggle" },
      { "s", desc = "Flash jump" },
      { "S", desc = "Flash treesitter" },
      { "K", desc = "Hover docs" },
    })
  end,
}
