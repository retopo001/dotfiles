#!/bin/bash
# Toggle dictation using whisper-dictate (C++ real-time transcription with direct typing)

PIDFILE="/tmp/dictate.pid"
MODEL="/usr/share/whisper.cpp-model-large-v3-turbo/ggml-large-v3-turbo.bin"
CAPTURE_DEVICE=4  # MOTU M2

start() {
    if [ -f "$PIDFILE" ]; then
        stop
        return
    fi

    /home/bw/bin/whisper-dictate \
        -m "$MODEL" \
        -c "$CAPTURE_DEVICE" \
        -l en \
        --step 2000 \
        --length 5000 \
        --vad-thold 0.5 \
        --keep-context \
        2>/dev/null &

    echo $! > "$PIDFILE"
    notify-send -t 1000 "Dictation ON"
}

stop() {
    if [ -f "$PIDFILE" ]; then
        pid=$(cat "$PIDFILE")
        kill "$pid" 2>/dev/null
        rm -f "$PIDFILE"
        notify-send -t 1000 "Dictation OFF"
    fi
}

case "$1" in
    start|toggle) start ;;
    stop) stop ;;
    *) echo "Usage: $0 toggle|stop" ;;
esac
