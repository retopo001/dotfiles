#!/bin/bash
# Screensaver command - runs inside terminal (X11)

SCREENSAVER_TEXT="${HOME}/.config/branding/screensaver.txt"

if [[ ! -f "$SCREENSAVER_TEXT" ]]; then
    SCREENSAVER_TEXT="${HOME}/.config/omarchy/branding/screensaver.txt"
fi

exit_screensaver() {
    pkill -x tte 2>/dev/null
    exit 0
}

trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT

# Enable mouse tracking for exit detection
printf '\e[?1000h\e[?1003h'

# Flush input buffer
while read -rsn1 -t 0.1; do :; done

# Set black background
printf '\033]11;rgb:00/00/00\007'

tty=$(tty 2>/dev/null)

while true; do
    tte -i "$SCREENSAVER_TEXT" \
        --frame-rate 120 --canvas-width 0 --canvas-height 0 \
        --reuse-canvas --anchor-canvas c --anchor-text c \
        --random-effect --exclude-effects dev_worm \
        --no-eol --no-restore-cursor &

    while pgrep -t "${tty#/dev/}" -x tte >/dev/null; do
        if read -rsn1 -t 1; then
            exit_screensaver
        fi
    done
done
