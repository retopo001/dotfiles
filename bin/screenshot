#!/bin/bash
# Screenshot with satty editing (X11)

[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs
OUTPUT_DIR="${XDG_PICTURES_DIR:-$HOME/Pictures}"
mkdir -p "$OUTPUT_DIR"

# Cancel if slop is already running
pkill slop 2>/dev/null && exit 0

if [[ "$1" == "--clipboard" ]]; then
    SELECTION=$(slop -f "%g" 2>/dev/null)
    [ -z "$SELECTION" ] && exit 0
    maim -g "$SELECTION" | xclip -selection clipboard -t image/png
    notify-send "Screenshot copied to clipboard"
else
    SELECTION=$(slop -f "%g" 2>/dev/null)
    [ -z "$SELECTION" ] && exit 0

    maim -g "$SELECTION" - | satty --filename - \
        --output-filename "$OUTPUT_DIR/screenshot-$(date +'%Y-%m-%d_%H-%M-%S').png" \
        --early-exit \
        --actions-on-enter save-to-clipboard \
        --save-after-copy \
        --copy-command 'xclip -selection clipboard -t image/png'
fi
